<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Find Stores - कृषिMitra</title>

  <link rel="shortcut icon" href="./favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="./assets/css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">

  <style>
    /* --- RESET & VARIABLES --- */
    :root {
      --primary: #1e7e34;
      --primary-dark: #155724;
      --primary-light: #e8f5e9;
      --text-dark: #2d3436;
      --text-light: #636e72;
      --white: #ffffff;
      --shadow-sm: 0 4px 6px rgba(0,0,0,0.05);
      --shadow-md: 0 10px 15px rgba(0,0,0,0.1);
    }
    
    /* Removed body font-size override so it matches homepage */
    body { font-family: 'Montserrat', sans-serif; background-color: #f9fbfd; }

    /* --- 1. MASTER HEADER (Exact Match) --- */
    .header { background: var(--white); box-shadow: var(--shadow-sm); position: sticky; top: 0; z-index: 1000; }
    .header .container { display: flex !important; align-items: center !important; justify-content: space-between !important; padding-block: 15px; }
    
    .navbar-list { display: flex; align-items: center; gap: 30px; margin: 0; padding: 0; list-style: none; }
    
    /* Removed specific font-size here so it uses your global style.css size */
    .navbar-link { font-weight: 600; color: var(--davys-gray); padding: 10px 0; text-decoration: none; transition: 0.3s; }
    .navbar-link:hover, .navbar-link.active { color: var(--primary); }
    
    .header-right-group { display: flex !important; align-items: center !important; gap: 20px; margin-left: auto; }
    
    .nav-cart-box { position: relative; font-size: 1.8rem; color: #333; cursor: pointer; display: flex; align-items: center; margin-right: 5px; }
    .cart-badge { position: absolute; top: -8px; right: -10px; background-color: #ff4757; color: white; font-size: 0.75rem; font-weight: bold; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    
    .lang-box { display: flex; align-items: center; background-color: #ffffff; border: 1px solid #e0e0e0; border-radius: 50px; padding: 0 15px; min-width: 110px; height: 45px; overflow: hidden; }
    .lang-box ion-icon { font-size: 1.5rem; color: #333; margin-right: 8px; }
    #language-select { border: none; outline: none; background: transparent; font-family: 'Montserrat'; font-weight: 600; color: #333; font-size: 1rem; cursor: pointer; width: 100%; }
    
    .header .btn { margin-inline-start: 0 !important; padding: 0 40px !important; height: 45px !important; display: flex !important; align-items: center !important; justify-content: center !important; font-size: 1.1rem !important; font-weight: 700 !important; min-width: 140px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    
    .nav-profile-btn { width: 45px; height: 45px; background-color: #1e7e34; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; text-decoration: none; transition: 0.3s; }
    .nav-profile-btn:hover { background-color: #155724; }

    /* --- 2. HERO SECTION --- */
    .page-banner { 
      padding: 100px 0 120px; 
      background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
      text-align: center; 
      position: relative;
    }
    .page-banner .h1 { 
      font-family: 'Playfair Display', serif; 
      color: var(--primary-dark); 
      font-size: 3.5rem; 
      margin-bottom: 15px; 
    }
    .page-banner .p { 
      font-size: 1.2rem; 
      color: var(--text-light); 
      max-width: 700px; 
      margin: 0 auto; 
      line-height: 1.6;
    }

    /* --- IMPROVED SEARCH BAR --- */
    .search-wrapper { margin-top: -50px; position: relative; z-index: 10; }
    .search-container { max-width: 850px; margin: 0 auto; padding: 0 20px; }
    
    .search-box { 
      background: var(--white); 
      padding: 10px; 
      border-radius: 100px; 
      box-shadow: 0 15px 40px rgba(0,0,0,0.1); 
      display: flex; 
      align-items: center; 
      border: 1px solid rgba(0,0,0,0.05);
      height: 70px; 
    }
    .search-icon { font-size: 1.8rem; color: #bbb; margin-left: 25px; }
    .search-input { 
      flex-grow: 1; 
      border: none; 
      padding: 0 20px; 
      font-size: 1.2rem; 
      outline: none; 
      font-family: 'Montserrat', sans-serif; 
      color: #333;
    }
    .locate-btn { 
      background: var(--primary); 
      color: white; 
      border: none; 
      padding: 0 35px; 
      height: 54px; 
      border-radius: 50px; 
      cursor: pointer; 
      font-weight: 600; 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      font-size: 1.1rem;
      transition: 0.3s;
      white-space: nowrap;
    }
    .locate-btn:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(30, 126, 52, 0.3); }
    
    /* --- 3. STORES GRID --- */
    .grid-list { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); 
      gap: 30px; 
      padding-top: 40px;
    }
    
    .store-card { 
      background: var(--white); 
      border-radius: 20px; 
      overflow: hidden; 
      border: 1px solid #edf2f7; 
      box-shadow: var(--shadow-sm); 
      transition: all 0.3s ease; 
      display: flex; 
      flex-direction: column;
      height: 100%;
    }
    
    .store-card:hover { 
      transform: translateY(-8px); 
      box-shadow: var(--shadow-md); 
      border-color: var(--primary-light);
    }
    
    .store-header { 
      padding: 25px; 
      border-bottom: 1px solid #f1f3f5; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      background: #ffffff;
    }
    .store-name { font-size: 1.4rem; font-weight: 700; color: var(--text-dark); margin: 0; line-height: 1.3; }
    
    .status-badge { 
      font-size: 0.8rem; 
      font-weight: 700; 
      padding: 8px 15px; 
      border-radius: 30px; 
      text-transform: uppercase; 
      letter-spacing: 0.5px;
    }
    .status-open { background: #dcfce7; color: #166534; }
    .status-closed { background: #fee2e2; color: #991b1b; }

    .store-body { padding: 30px 25px; flex-grow: 1; }
    .info-row { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; color: #555; font-size: 1.05rem; }
    .info-row ion-icon { color: var(--primary); font-size: 1.5rem; margin-top: 2px; }
    
    .card-actions { 
      padding: 25px; 
      background: #f8fafc; 
      border-top: 1px solid #f1f3f5; 
      display: flex; 
      gap: 15px; 
    }
    .action-btn { 
      flex: 1; 
      padding: 14px; 
      border-radius: 12px; 
      font-weight: 600; 
      text-align: center; 
      text-decoration: none; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 10px; 
      font-size: 1rem; 
      transition: 0.2s;
    }
    .btn-call { background: var(--primary); color: white; border: none; }
    .btn-call:hover { background: var(--primary-dark); }
    .btn-map { background: white; color: var(--text-dark); border: 1px solid #e2e8f0; }
    .btn-map:hover { background: #f1f5f9; border-color: #cbd5e1; }

    /* Responsive */
    @media (max-width: 992px) { 
        .navbar { display: none; } 
        .header-right-group { margin-right: 60px; gap: 10px; } 
        .lang-box { padding: 0 8px; min-width: auto; height: 40px !important; }
        .header .btn { padding: 0 15px !important; height: 40px !important; font-size: 0.9rem !important; min-width: auto; }
        
        .page-banner .h1 { font-size: 2.5rem; }
        .search-box { flex-direction: column; padding: 15px; border-radius: 25px; height: auto; }
        .locate-btn { width: 100%; justify-content: center; margin-top: 10px; height: 50px; }
        .search-icon { display: none; }
        .search-input { padding: 10px; text-align: center; width: 100%; }
        .popular-tags { flex-direction: column; gap: 10px; }
    }
  </style>
</head>

<body id="top">

  <header class="header" data-header>
    <div class="container">
      <a href="index.html" class="logo">कृषिMitra<span class="span">.</span></a>
      <nav class="navbar" data-navbar>
        <button class="nav-toggle-btn" aria-label="close menu" data-nav-toggler><ion-icon name="close-outline"></ion-icon></button>
        <ul class="navbar-list">
          <li class="navbar-item"><a href="index.html" class="navbar-link" data-i18n="nav_home">Home</a></li>
          <li class="navbar-item"><a href="news.html" class="navbar-link" data-i18n="nav_news">News</a></li>
          <li class="navbar-item"><a href="fertilizer-store.html" class="navbar-link active" data-i18n="nav_store">Marketplace</a></li>
          <li class="navbar-item"><a href="crop-guide.html" class="navbar-link" data-i18n="nav_guide">Crop Guide</a></li>
          <li class="navbar-item"><a href="weather.html" class="navbar-link" data-i18n="nav_weather">Weather</a></li>
          <li class="navbar-item"><a href="contact.html" class="navbar-link" data-i18n="nav_contact">Contact</a></li>
        </ul>
      </nav>
      <div class="header-right-group">
        <a href="fertilizer-store.html" class="nav-cart-box" title="Your Cart">
            <ion-icon name="cart-outline"></ion-icon>
            <span class="cart-badge" id="global-cart-count">0</span>
        </a>
        <div class="lang-box">
          <ion-icon name="language-outline"></ion-icon>
          <select id="language-select" onchange="changeLanguage(this.value)">
            <option value="en">English</option>
            <option value="hi">हिंदी</option>
          </select>
        </div>
        <div id="auth-container">
            <a href="signup.html" class="btn btn-primary" id="auth-button" data-i18n="btn_signup">Sign Up</a>
        </div>
      </div>
      <button class="nav-toggle-btn" aria-label="open manu" data-nav-toggler><ion-icon name="menu-outline"></ion-icon></button>
      <div class="overlay" data-nav-toggler data-overlay></div>
    </div>
  </header>

  <main>
    <article>
      <section class="section page-banner">
        <div class="container">
          <h1 class="h1">Fertilizer Store Locator</h1>
          <p class="p">Find authorized fertilizer dealers, Krishi Kendras, and agri-shops near you instantly.</p>
        </div>
      </section>

      <section class="search-wrapper">
        <div class="container search-container">
          <div class="search-box">
            <ion-icon name="search-outline" class="search-icon"></ion-icon>
            <input type="text" id="city-input" placeholder="Enter City or District (e.g., Jaipur, Kota)..." class="search-input">
            <button class="locate-btn" onclick="useMyLocation()">
                <ion-icon name="navigate-circle-outline"></ion-icon> Locate Me
            </button>
          </div>
          
         
        </div>
      </section>

      <section class="section blog" style="background-color: #f9fbfd; min-height: 600px;">
        <div class="container">
          <ul class="grid-list" id="store-grid">
             <div style="text-align: center; width: 100%; padding: 60px; color: #888;">
                <ion-icon name="storefront-outline" style="font-size: 4rem; color: #ddd; margin-bottom: 20px;"></ion-icon>
                <p style="font-size: 1.4rem; font-weight: 500;">Start by entering your city name above.</p>
             </div>
          </ul>
        </div>
      </section>
    </article>
  </main>

  <footer class="footer" id="footer">
    <div class="footer-bottom"><div class="container"><p class="copyright">© 2025 Krishimitr.</p></div></div>
  </footer>

  <script src="./assets/js/script.js" defer></script>
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

  <script>
    const MAP_API_KEY = "YOUR_TOMTOM_API_KEY"; 

    const searchInput = document.getElementById('city-input');
    const storeGrid = document.getElementById('store-grid');
    let timeout = null;

    searchInput.addEventListener('input', (e) => {
        clearTimeout(timeout);
        const city = e.target.value.trim();
        if (city.length < 3) return;
        timeout = setTimeout(() => { fetchStores(city); }, 800);
    });

    window.searchCity = function(city) {
        searchInput.value = city;
        fetchStores(city);
    }

    async function fetchStores(city) {
        storeGrid.innerHTML = '<p style="text-align:center; width:100%; padding:40px; font-size:1.2rem;"><ion-icon name="sync" class="spin" style="font-size:2rem;"></ion-icon><br>Searching nearby stores...</p>';

        const url = `https://us-central1-krishimitra-in.cloudfunctions.net/searchStores?city=${encodeURIComponent(city)}`;

        try {
            // Simulate API if using placeholder key
            if (MAP_API_KEY === "YOUR_TOMTOM_API_KEY") {
                setTimeout(() => { simulateApiSearch(city); }, 600);
                return;
            }

            const response = await fetch(url);
            const data = await response.json();

            if (!data.results || data.results.length === 0) {
                storeGrid.innerHTML = `<p style="text-align:center; width:100%; color:red; font-size:1.2rem;">No shops found in ${city}.</p>`;
                return;
            }
            renderApiStores(data.results);
        } catch (error) {
            console.error("Backend Error:", error);
            simulateApiSearch(city);
        }
    }

    function renderApiStores(results) {
        storeGrid.innerHTML = '';

        results.forEach(place => {
            const name = place.poi ? place.poi.name : place.name;
            const address = place.address.freeformAddress || place.address;
            const phone = (place.poi && place.poi.phone) ? place.poi.phone : "+91-9876543210"; 
            
            const isOpen = Math.random() > 0.2; 
            const statusClass = isOpen ? "status-open" : "status-closed";
            const statusText = isOpen ? "OPEN NOW" : "CLOSED";

            const html = `
                <li>
                    <div class="store-card">
                        <div class="store-header">
                            <h3 class="store-name">${name}</h3>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        
                        <div class="store-body">
                            <div class="info-row">
                                <ion-icon name="location-outline"></ion-icon>
                                <span>${address}</span>
                            </div>
                            <div class="info-row">
                                <ion-icon name="call-outline"></ion-icon>
                                <span>${phone}</span>
                            </div>
                            <div class="info-row">
                                <ion-icon name="time-outline"></ion-icon>
                                <span>Mon - Sat: 9:00 AM - 8:00 PM</span>
                            </div>
                        </div>

                        <div class="card-actions">
                            <a href="tel:${phone}" class="action-btn btn-call"><ion-icon name="call"></ion-icon> Call Shop</a>
                            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name + ' ' + address)}" target="_blank" class="action-btn btn-map"><ion-icon name="map"></ion-icon> Navigate</a>
                        </div>
                    </div>
                </li>
            `;
            storeGrid.innerHTML += html;
        });
    }

    function simulateApiSearch(city) {
        const mockResults = [
            { name: `Sharma Krishi Kendra`, phone: "9988776655", address: `Main Market, Near Railway Station, ${city}` },
            { name: `${city} Agro Solutions`, phone: "9876543210", address: `Plot No. 45, Industrial Area, ${city}` },
            { name: `Jai Jawan Fertilizer Store`, phone: "8877665544", address: `Highway 12, Opposite Bus Stand, ${city}` },
            { name: `Green Field Agri Inputs`, phone: "9123456789", address: `Shop 12, Grain Market, ${city}` },
            { name: `Kisan Seva Centre`, phone: "9000012345", address: `Village Road, Near Temple, ${city}` },
            { name: `National Fertilizers`, phone: "9566223311", address: `Sector 4, ${city}` }
        ];
        renderApiStores(mockResults);
    }

    function useMyLocation() {
        if(navigator.geolocation) {
            document.querySelector('.locate-btn').innerHTML = '<ion-icon name="sync" class="spin"></ion-icon> Locating...';
            navigator.geolocation.getCurrentPosition(() => {
                searchInput.value = "Jaipur"; 
                fetchStores("Jaipur");
                document.querySelector('.locate-btn').innerHTML = '<ion-icon name="navigate-circle-outline"></ion-icon> Locate Me';
            }, () => {
                alert("Location access denied.");
                document.querySelector('.locate-btn').innerHTML = '<ion-icon name="navigate-circle-outline"></ion-icon> Locate Me';
            });
        } else {
            alert("Geolocation not supported.");
        }
    }

    const translations = { en: { nav_home: "Home", nav_store: "Find Stores", btn_signup: "Sign Up" }, hi: { nav_home: "होम", nav_store: "दुकानें खोजें", btn_signup: "साइन अप" } };
    function changeLanguage(lang) { 
        const elements = document.querySelectorAll('[data-i18n]');
        elements.forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[lang] && translations[lang][key]) el.textContent = translations[lang][key];
        });
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        const count = localStorage.getItem('krishiCartCount') || 0;
        document.getElementById('global-cart-count').textContent = count;
    });
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { firebaseConfig } from "./assets/js/config.js"; 

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const authContainer = document.getElementById('auth-container');

    if (authContainer) {
      onAuthStateChanged(auth, (user) => {
        const currentLang = document.getElementById('language-select').value;
        const dict = translations[currentLang];
        if (user) {
          authContainer.innerHTML = `<a href="dashboard.html" class="nav-profile-btn"><ion-icon name="person-circle-outline"></ion-icon></a>`;
        } else {
          authContainer.innerHTML = `<a href="signup.html" class="btn btn-primary" id="auth-button">${dict.btn_signup}</a>`;
        }
      });
    }
  </script>

</body>
</html>