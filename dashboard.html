<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>My Dashboard - कृषिMitra</title>

  <link rel="shortcut icon" href="./favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="./assets/css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">

  <style>
    /* --- HEADER STYLES --- */
    .header .container { display: flex !important; align-items: center !important; justify-content: space-between !important; padding-block: 15px; }
    .navbar-list { display: flex; align-items: center; gap: 30px; margin: 0; padding: 0; list-style: none; }
    .navbar-link { font-weight: 600; color: var(--davys-gray); padding: 10px 0; text-decoration: none; transition: 0.3s; display: flex; align-items: center; gap: 5px; }
    
    /* DROPDOWN MENU */
    .dropdown-wrapper { position: relative; }
    .dropdown-menu {
      position: absolute; top: 100%; left: 50%; transform: translateX(-50%) translateY(20px);
      background: white; min-width: 220px; border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15); padding: 10px;
      opacity: 0; visibility: hidden; transition: all 0.3s ease;
      z-index: 1100; border: 1px solid #f0f0f0;
    }
    .dropdown-wrapper:hover .dropdown-menu { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
    .dropdown-menu::before { content: ''; position: absolute; top: -6px; left: 50%; transform: translateX(-50%) rotate(45deg); width: 12px; height: 12px; background: white; border-top: 1px solid #f0f0f0; border-left: 1px solid #f0f0f0; }
    .dropdown-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; color: #444; font-weight: 600; text-decoration: none; border-radius: 8px; transition: 0.2s; font-size: 0.95rem; }
    .dropdown-item:hover { background: #e8f5e9; color: #1e7e34; }

    /* DASHBOARD STYLES */
    .dashboard-header { padding-top: 150px; padding-bottom: 40px; background-color: var(--cultured); }
    .dashboard-header .h1 { font-family: 'Playfair Display', serif; font-size: 2.5rem; color: var(--black-chocolate); margin-bottom: 10px; }
    .dashboard-header .p { font-size: 1.1rem; color: var(--davys-gray); }

    .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
    .dashboard-main { display: flex; flex-direction: column; gap: 30px; }
    .dashboard-sidebar { display: flex; flex-direction: column; gap: 30px; }

    .current-weather-card { 
        background: linear-gradient(135deg, #1e7e34, #2ecc71); 
        color: white; 
        border-radius: 15px; 
        padding: 30px; 
        position: relative; 
        overflow: hidden; 
        box-shadow: 0 10px 30px rgba(30, 126, 52, 0.2);
    }
    .current-weather-card .location { font-size: 1.8rem; font-weight: 700; margin-bottom: 5px; font-family: 'Playfair Display', serif; }
    .current-weather-card .date { font-size: 0.9rem; opacity: 0.9; margin-bottom: 20px; }
    .temp-details { display: flex; align-items: center; }
    .current-weather-card .current-temp { font-size: 4.5rem; font-weight: 700; font-family: 'Playfair Display', serif; line-height: 1; }

    .mandi-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    .mandi-table th, .mandi-table td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; font-size: 0.95rem; }
    .mandi-table th { color: #1e7e34; font-weight: 700; }
    .mandi-table td { color: #444; }
    .price-up { color: #28a745; font-weight: bold; }
    .price-down { color: #dc3545; font-weight: bold; }

    .vitals-card { background-color: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #eee; }
    .vitals-card .h3 { font-size: 1.3rem; margin-bottom: 15px; text-align: center; color: #333; font-family: 'Playfair Display', serif; }
    .vitals-list { padding: 0; list-style: none; }
    .vitals-list li { display: flex; justify-content: space-between; padding-block: 12px; border-bottom: 1px dashed #ddd; font-size: 1rem; color: #555; }
    .vitals-list li:last-child { border-bottom: none; }
    .vitals-list span:last-child { font-weight: 600; color: #333; }
    
    .crop-suggestion-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; list-style: none; padding: 0; }
    
    .header .btn { padding: 0 30px !important; height: 40px !important; display: flex !important; align-items: center !important; justify-content: center !important; font-size: 0.9rem !important; font-weight: 600 !important; border-radius: 50px; }

    /* --- PROFILE SETUP MODAL --- */
    #profile-modal {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;
    }
    .modal-content {
        background: white; padding: 40px; border-radius: 15px; width: 90%; max-width: 500px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
    .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
    .form-group input:focus, .form-group select:focus { border-color: #1e7e34; }
    /* Readonly inputs look slightly grayed out */
    .form-group input:read-only { background-color: #f9f9f9; color: #777; cursor: not-allowed; }

    /* Mobile Fix */
    @media (max-width: 992px) { 
        .dashboard-grid { grid-template-columns: 1fr; } 
        .navbar { display: none; } 
        .dropdown-menu { position: static; transform: none; box-shadow: none; border: none; padding-left: 20px; background: #f9f9f9; display: none; opacity: 1; visibility: visible; }
        .dropdown-wrapper:hover .dropdown-menu { display: block; }
        .header-right-group { margin-left: auto; margin-right: 50px; }
    }
  </style>
</head>

<body id="top">

  <header class="header" data-header>
    <div class="container">
      <a href="index.html" class="logo">कृषिMitr<span class="span">.</span></a>
      <nav class="navbar" data-navbar>
        <button class="nav-toggle-btn" aria-label="close menu" data-nav-toggler><ion-icon name="close-outline"></ion-icon></button>
        <ul class="navbar-list">
          <li class="navbar-item"><a href="index.html" class="navbar-link">Home</a></li>
          <li class="navbar-item"><a href="news.html" class="navbar-link">News</a></li>
          <li class="navbar-item dropdown-wrapper">
            <a href="#" class="navbar-link">Marketplace <ion-icon name="chevron-down-outline" style="font-size: 1rem;"></ion-icon></a>
            <ul class="dropdown-menu">
                <li><a href="fertilizer-store.html" class="dropdown-item"><ion-icon name="storefront-outline"></ion-icon> Find Stores</a></li>
                <li><a href="mandi-prices.html" class="dropdown-item"><ion-icon name="bar-chart-outline"></ion-icon> Mandi Prices</a></li>
            </ul>
          </li>
          <li class="navbar-item"><a href="crop-guide.html" class="navbar-link">Crop Guide</a></li>
          <li class="navbar-item"><a href="weather.html" class="navbar-link">Weather</a></li>
          <li class="navbar-item"><a href="contact.html" class="navbar-link">Contact</a></li>
        </ul>
      </nav>
      <div class="header-right-group">
          <a href="#" class="btn btn-secondary" id="logout-button">Logout</a>
      </div>
      <button class="nav-toggle-btn" aria-label="open manu" data-nav-toggler><ion-icon name="menu-outline"></ion-icon></button>
      <div class="overlay" data-nav-toggler data-overlay></div>
    </div>
  </header>

  <main>
    <article>
      <section class="section dashboard-header">
        <div class="container">
          <h2 class="h2 section-title" id= "user-welcome" style="text-align: left; margin-bottom: 20px;">Namaste</h2>
          <h1 class="h1" id="user-location-sub">Loading your farm data...</h1>
        </div>
      </section>

      <section class="section dashboard-widgets">
        <div class="container">
          <div class="dashboard-grid">
            
            <div class="dashboard-main">
              <div class="dashboard-widget">
                <h2 class="h2 section-title" style="text-align: left; margin-bottom: 20px;">Live Weather</h2>
                <div class="current-weather-card">
                  <h2 class="location" id="weather-city">Loading...</h2>
                  <p class="date" id="weather-date">...</p>
                  <div class="temp-details">
                    <p class="current-temp" id="weather-temp">--°</p>
                    <div style="margin-left: 20px;">
                      <p style="font-size: 1.5rem; text-transform: capitalize; font-weight: 500;" id="weather-desc">--</p>
                      <p id="weather-hilo" style="opacity: 0.9;">H: --° / L: --°</p>
                    </div>
                  </div>
                  <div style="margin-top: 20px; font-size: 1.1rem; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
                    <span><ion-icon name="water-outline"></ion-icon> Humidity: <span id="weather-humidity">--%</span></span> &nbsp;&nbsp;|&nbsp;&nbsp; 
                    <span><ion-icon name="speedometer-outline"></ion-icon> Wind: <span id="weather-wind">-- km/h</span></span>
                  </div>
                </div>
              </div>

              <div class="dashboard-widget">
                <h2 class="h2 section-title" style="text-align: left; margin-bottom: 20px;">Recommended Crops for <span id="crop-state-name">Your State</span></h2>
                <ul class="crop-suggestion-list" id="crop-container">
                    <p>Loading recommendations...</p>
                </ul>
              </div>
            </div>

            <div class="dashboard-sidebar">
              <div class="vitals-card">
                <h3 class="h3">Mandi Prices (<span id="mandi-location">...</span>)</h3>
                <p style="font-size: 0.9rem; color: gray; text-align: center; margin-bottom: 10px;">Live market rates (₹/Quintal)</p>
                <table class="mandi-table">
                  <thead><tr><th>Crop</th><th>Price</th><th>Trend</th></tr></thead>
                  <tbody id="mandi-table-body"><tr><td colspan="3">Loading...</td></tr></tbody>
                </table>
                <a href="mandi-prices.html" class="btn btn-secondary" style="width: 100%; margin-top: 20px; text-align: center;">View All Markets</a>
              </div>
              
              <div class="vitals-card">
                <h3 class="h3">My Farm Profile</h3>
                <ul class="vitals-list">
                  <li><span>Owner</span><span style="font-weight: bold;" id="profile-name">--</span></li>
                  <li><span>Contact</span><span id="profile-contact">--</span></li>
                  <li><span>District</span><span id="profile-district">--</span></li>
                  <li><span>State</span><span id="profile-state">--</span></li>
                  <li><span>Size</span><span id="profile-size">-- Acres</span></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </section>
    </article>
  </main>

  <div id="profile-modal">
      <div class="modal-content">
          <h2 style="margin-bottom: 20px; color: #1e7e34;">Complete Your Profile</h2>
          <p style="margin-bottom: 20px; color: #666;">Please provide your farm details to get personalized weather & crop data.</p>
          <form id="profile-form">
              <div class="form-group">
                  <label>Full Name</label>
                  <input type="text" id="setup-name" required placeholder="Enter your name">
              </div>
              <div class="form-group">
                  <label>Phone Number (Linked)</label>
                  <input type="text" id="setup-phone" placeholder="e.g. +919876543210">
              </div>
              <div class="form-group">
                  <label>State</label>
                  <select id="setup-state" required>
                      <option value="">Select State</option>
                      <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
                      <option value="Andhra Pradesh">Andhra Pradesh</option>
                      <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                      <option value="Assam">Assam</option>
                      <option value="Bihar">Bihar</option>
                      <option value="Chandigarh">Chandigarh</option>
                      <option value="Chhattisgarh">Chhattisgarh</option>
                      <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman and Diu</option>
                      <option value="Delhi">Delhi</option>
                      <option value="Goa">Goa</option>
                      <option value="Gujarat">Gujarat</option>
                      <option value="Haryana">Haryana</option>
                      <option value="Himachal Pradesh">Himachal Pradesh</option>
                      <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                      <option value="Jharkhand">Jharkhand</option>
                      <option value="Karnataka">Karnataka</option>
                      <option value="Kerala">Kerala</option>
                      <option value="Ladakh">Ladakh</option>
                      <option value="Lakshadweep">Lakshadweep</option>
                      <option value="Madhya Pradesh">Madhya Pradesh</option>
                      <option value="Maharashtra">Maharashtra</option>
                      <option value="Manipur">Manipur</option>
                      <option value="Meghalaya">Meghalaya</option>
                      <option value="Mizoram">Mizoram</option>
                      <option value="Nagaland">Nagaland</option>
                      <option value="Odisha">Odisha</option>
                      <option value="Puducherry">Puducherry</option>
                      <option value="Punjab">Punjab</option>
                      <option value="Rajasthan">Rajasthan</option>
                      <option value="Sikkim">Sikkim</option>
                      <option value="Tamil Nadu">Tamil Nadu</option>
                      <option value="Telangana">Telangana</option>
                      <option value="Tripura">Tripura</option>
                      <option value="Uttar Pradesh">Uttar Pradesh</option>
                      <option value="Uttarakhand">Uttarakhand</option>
                      <option value="West Bengal">West Bengal</option>
                  </select>
              </div>
              <div class="form-group">
                  <label>District / City</label>
                  <input type="text" id="setup-district" required placeholder="e.g. Jaipur">
              </div>
              <div class="form-group">
                  <label>Farm Size (Acres)</label>
                  <input type="number" id="setup-size" required placeholder="e.g. 5">
              </div>
              <button type="submit" class="btn btn-primary" style="width: 100%;">Save Profile</button>
          </form>
      </div>
  </div>

  <footer class="footer" id="footer">
      <div class="footer-bottom"><div class="container"><p class="copyright">&copy; 2025 Krishimitr.</p></div></div>
  </footer>

  <a href="#top" class="back-top-btn" aria-label="back to top" data-back-top-btn><ion-icon name="chevron-up"></ion-icon></a>

  <script src="./assets/js/script.js" defer></script>
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

  <script type="module">
    // 1. Import PRE-INITIALIZED Auth & DB
    import { auth, db } from "./assets/js/config.js"; 
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const WEATHER_API_KEY = "71ca48bb8af57498e0efdabac5f86f4d"; 
    let currentUser = null;

    const cropDatabase = {
        "Rajasthan": [ { name: "Bajra", type: "Kharif", desc: "Drought tolerant." }, { name: "Mustard", type: "Rabi", desc: "High oil content." } ],
        "Punjab": [ { name: "Wheat", type: "Rabi", desc: "Staple food." }, { name: "Rice", type: "Kharif", desc: "High yield." } ],
        "Maharashtra": [ { name: "Cotton", type: "Kharif", desc: "Cash crop." }, { name: "Sugarcane", type: "Annual", desc: "High water needed." } ],
        "Other": [ { name: "Tomato", type: "Zaid", desc: "Vegetable." }, { name: "Wheat", type: "Rabi", desc: "Winter crop." } ]
    };

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        const docRef = doc(db, "farmers", user.uid);
        const docSnap = await getDoc(docRef);

        // --- CHECK IF PROFILE IS COMPLETE ---
        if (docSnap.exists() && docSnap.data().district && docSnap.data().state) {
            updateUI(docSnap.data());
        } else {
            // Profile missing details -> Show Modal
            const phoneInput = document.getElementById('setup-phone');
            if (user.phoneNumber) {
                phoneInput.value = user.phoneNumber;
                phoneInput.setAttribute("readonly", true); // Lock it
                phoneInput.style.backgroundColor = "#e8f5e9"; 
            } else {
                phoneInput.value = ""; 
            }
            document.getElementById('profile-modal').style.display = 'flex';
        }

        document.getElementById('logout-button').addEventListener('click', (e) => {
            e.preventDefault();
            signOut(auth).then(() => window.location.href = 'index.html');
        });

      } else {
        window.location.href = 'login.html';
      }
    });

    // --- HANDLE PROFILE FORM SUBMISSION ---
    document.getElementById('profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if(!currentUser) return;

        const newData = {
            fullName: document.getElementById('setup-name').value,
            phone: document.getElementById('setup-phone').value, 
            state: document.getElementById('setup-state').value,
            district: document.getElementById('setup-district').value,
            farmSize: document.getElementById('setup-size').value,
            email: currentUser.email || "" 
        };

        try {
            await setDoc(doc(db, "farmers", currentUser.uid), newData, { merge: true });
            document.getElementById('profile-modal').style.display = 'none';
            updateUI(newData);
            alert("Profile Linked & Saved Successfully!");
        } catch (error) {
            console.error("Error saving profile:", error);
            alert("Error: " + error.message);
        }
    });

    // --- UI UPDATERS ---
    function updateUI(data) {
        if (!data) return;
        // PERSONALIZED GREETING (THE FIX)
        document.getElementById('user-welcome').textContent = `Namaste, ${data.fullName || 'Farmer'}!`;
        document.getElementById('user-location-sub').textContent = `Farm Dashboard for ${data.district}, ${data.state}`;
        document.getElementById('profile-name').textContent = data.fullName || '--';
        document.getElementById('profile-contact').textContent = data.phone || data.email || '--';
        document.getElementById('profile-district').textContent = data.district || '--';
        document.getElementById('profile-state').textContent = data.state || '--';
        document.getElementById('profile-size').textContent = (data.farmSize || '--') + " Acres";
        document.getElementById('mandi-location').textContent = data.district || 'Local';
        document.getElementById('crop-state-name').textContent = data.state || 'Your Region';

        if (data.district) fetchRealWeather(data.district);
        const stateKey = cropDatabase[data.state] ? data.state : "Other";
        generateCropSuggestions(stateKey);
        generateMandiPrices();
    }

    async function fetchRealWeather(city) {
        const url = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${WEATHER_API_KEY}&units=metric`;
        try {
            const res = await fetch(url);
            const weather = await res.json();
            if(weather.cod === 200) {
                document.getElementById('weather-city').textContent = weather.name;
                document.getElementById('weather-temp').textContent = Math.round(weather.main.temp) + "°C";
                document.getElementById('weather-desc').textContent = weather.weather[0].description;
                document.getElementById('weather-hilo').textContent = `H: ${Math.round(weather.main.temp_max)}° / L: ${Math.round(weather.main.temp_min)}°`;
                document.getElementById('weather-humidity').textContent = weather.main.humidity + "%";
                document.getElementById('weather-wind').textContent = weather.wind.speed + " m/s";
                const now = new Date();
                document.getElementById('weather-date').textContent = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            }
        } catch (e) { console.error("Weather Error", e); }
    }

    function generateCropSuggestions(state) {
        const container = document.getElementById('crop-container');
        const crops = cropDatabase[state] || cropDatabase["Other"];
        container.innerHTML = ""; 
        crops.forEach(crop => {
            const html = `
              <div class="course-card" style="padding: 20px; border: 1px solid #eee; background: white; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">
                  <h3 class="h3" style="color: var(--black-chocolate); font-size: 1.2rem;">${crop.name}</h3>
                  <span style="background: #e6f4ea; color: #1e7e34; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; display:inline-block; margin-bottom:8px;">${crop.type}</span>
                  <p style="margin-top: 5px; font-size: 0.9rem; color: #555;">${crop.desc}</p>
                  <a href="crop-guide.html" class="btn btn-secondary" style="margin-top: 15px; padding: 5px 15px; font-size: 0.8rem; min-width:auto; height:30px;">View Guide</a>
              </div>`;
            container.innerHTML += html;
        });
    }

    function generateMandiPrices() {
        const tbody = document.getElementById('mandi-table-body');
        const basePrices = [ { name: "Wheat", price: 2125 }, { name: "Mustard", price: 5450 }, { name: "Rice", price: 2040 } ];
        tbody.innerHTML = "";
        basePrices.forEach(crop => {
            const livePrice = crop.price + Math.floor(Math.random() * 50) - 25;
            const trend = Math.random() > 0.5 ? "up" : "down";
            const arrow = trend === "up" ? "▲" : "▼";
            const colorClass = trend === "up" ? "price-up" : "price-down";
            tbody.innerHTML += `<tr><td>${crop.name}</td><td>₹${livePrice}</td><td class="${colorClass}">${arrow}</td></tr>`;
        });
    }
  </script>

</body>
</html>